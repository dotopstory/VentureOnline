<!DOCTYPE html>
<html>
    <head>
        <!-- Meta -->
        <title>Venture Online</title>
        <meta charset="UTF-8">
        <meta name="description" content="Multiplayer online JS game">
        <meta name="keywords" content="HTML,CSS,XML,JavaScript">
        <meta name="author" content="Taylar Keast">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <!-- jQuery -->
        <script src="https://code.jquery.com/jquery-3.2.1.js" integrity="sha256-DZAnKJ/6XZ9si04Hgrsxu/8s717jcIzLy3oi35EouyE=" crossorigin="anonymous"></script>

        <!-- Bootstrap 4 -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">

        <!-- SOCKET.IO -->
        <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>

        <!-- Custom Styles -->
        <link rel="stylesheet" type="text/css" href="/client/css/styles_page.css">
        <link rel="stylesheet" type="text/css" href="/client/css/styles_chat.css">

        <!-- Fonts -->
        <link href="https://fonts.googleapis.com/css?family=Bungee|Ubuntu:700" rel="stylesheet">

        <!-- Animate.css -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">
    </head>

    <body>
        <div class="container-fluid">
            <!-- NAVBAR-->
            <div class="row nav">
                <div class="col-md-6 col-logo">
                    <a href="/play"><span class="logo">Venture Online</span></a>
                </div>

                <div class="col-md-6 col-links">
                    <a href="/play"><span class="navItem">Play!</span></a>
                    <a href="/about"><span class="navItem">About</span></a>
                    <span class="navItem">Bug Report</span>
                </div>
            </div>

            <!-- Sign in row -->
            <div id="div-signIn" class="row animated slideInLeft">
                <div class="col-md-4 offset-md-4">
                    <span class="label">Choose Username</span>
                    <input id="signInUsernameTextbox" type="text" class="form-control" autofocus>
                    <input id="signInSubmitButton" type="button" class="btn-play" value="Play!">
                </div>
            </div>

            <!-- Canvas row -->
            <div id="div-game" style="display: none;">
                <!-- Game canvas row -->
                <div class="row canvas-row">
                    <div class="col-md-12">
                        <canvas id="ctx"></canvas>
                    </div>
                </div>

                <!-- Chat row -->
                <div class="row">
                    <div class="col-md-8 offset-md-2">
                        <div id="chat-text">
                            <div class="chat-message">Welcome to Venture.</div>
                        </div>

                        <form id="chat-form">
                            <input id="chat-input" type="text" class="form-control" placeholder="Type message here.." required autocomplete="off"></input>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </body>

    <script>
        //Open socket
        var socket = io();

        //Sign in objects
        var signInDiv = document.getElementById('div-signIn');
        var tbUsername = document.getElementById('signInUsernameTextbox');
        var btnSignIn = document.getElementById('signInSubmitButton');

        //Send sign in
        function sendSignInRequest() {
            socket.emit('signIn', {username: tbUsername.value, password: ""});
        }

        //Receive sign in response
        socket.on('signInResponse', function(data) {
            if(data.success) {
                signInDiv.style.display = "none";
                gameDiv.style.display = "inline";
            } else {
                console.log("Error - failed sign in.");
            }
        });

        //Game objects
        var gameDiv = document.getElementById('div-game');
        var chatText = document.getElementById('chat-text');
        var chatInput = document.getElementById('chat-input');
        var chatForm = document.getElementById('chat-form');
        var ctx = document.getElementById('ctx').getContext('2d');
        ctx.font = "20px Arial";

        //Player cache class
        class Player {
            constructor(initPack) {
                this.id = initPack.id;
                this.x = initPack.x;
                this.y = initPack.y;
                Player.list[this.id] = this;
            }
        }
        Player.list = {};

        //Projectile cache class
        class Projectile {
            constructor(initPack) {
                this.id = initPack.id;
                this.x = initPack.x;
                this.y = initPack.y;
                Projectile.list[this.id] = this;
            }
        }
        Projectile.list = {};

        //Listen for player packet updates
        socket.on('init', function(data) {
            //Draw players
            for(var i = 0; i < data.players.length; i++) {
                new Player(data.players[i]);
            }

            //Draw projectiles
            for(var i = 0; i < data.projectiles.length; i++) {
                new Projectile(data.projectiles[i]);
            }
        });

        //Listen for player packet updates
        socket.on('update', function(data) {
            //Draw players
            for(var i in data.players) {
                //Update player data
                var pack = data.players[i];
                var p = Player.list[pack.id];
                if(p) {
                    if(pack.x !== undefined) p.x = pack.x;
                    if(pack.y !== undefined) p.y = pack.y;
                }
            }

            //Update projectiles
            for(var i = 0; i < data.projectiles.length; i++) {
                var pack = data.projectiles[i];
                var p = Projectile.list[data.projectiles[i].id];
                if(p) {
                    if(pack.x !== undefined) p.x = pack.x;
                    if(pack.y !== undefined) p.y = pack.y;
                }
            }
        });

        socket.on('remove', function(data) {
            for(var i = 0; i < data.players.length; i++)
                delete Player.list[data.players[i]];

            for(var i = 0; i < data.projectiles.length; i++)
                delete Projectile.list[data.projectiles[i]];
        });

        setInterval(function() {
            ctx.clearRect(0, 0, 800, 600);
            for(var i in Player.list)
                ctx.fillText(Player.list[i].id, Player.list[i].x, Player.list[i].y);

            for(var i in Projectile.list)
                ctx.fillRect(Projectile.list[i].x - 5, Projectile.list[i].y - 5, 10, 10);
        }, 40);
    </script>
    <script src="client/js/events_ui.js"></script>
    <script src="client/js/events_chat.js"></script>
    <script src="client/js/events_input.js"></script>
</html>
